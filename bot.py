import os
import logging
import smtplib
import random
import time
from collections import deque
from email.mime.text import MIMEText
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ContextTypes,
    filters
)
from openai import OpenAI

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#                    ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸ email-ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ‚Ğ¾ĞºĞµĞ½Ğ°Ñ…
logging.basicConfig(
    filename="error.log",
    filemode="a",
    format="%(asctime)s | %(levelname)s | %(message)s",
    level=logging.INFO
)

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¿Ğ¸ÑÑŒĞ¼Ğ° Ñ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ (ĞµÑĞ»Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ SMTP)
def send_error_email(subject: str, body: str) -> None:
    """
    ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ email Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ñ‚ĞµĞ¼Ğ¾Ğ¹ Ğ¸ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼ (body).
    Ğ¢Ñ€ĞµĞ±ÑƒÑÑ‚ÑÑ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ:
      EMAIL_SMTP_SERVER, EMAIL_SMTP_PORT,
      EMAIL_USER, EMAIL_PASSWORD, EMAIL_TO
    """
    try:
        smtp_server = os.getenv("EMAIL_SMTP_SERVER")
        smtp_port = int(os.getenv("EMAIL_SMTP_PORT", "587"))
        email_user = os.getenv("EMAIL_USER")
        email_pass = os.getenv("EMAIL_PASSWORD")
        email_to = os.getenv("EMAIL_TO")

        if not all([smtp_server, smtp_port, email_user, email_pass, email_to]):
            return

        msg = MIMEText(body, _charset="utf-8")
        msg["Subject"] = subject
        msg["From"] = email_user
        msg["To"] = email_to

        with smtplib.SMTP(smtp_server, smtp_port) as server:
            server.starttls()
            server.login(email_user, email_pass)
            server.sendmail(email_user, [email_to], msg.as_string())
    except Exception as e:
        logging.error(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ email: {e}")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#                      ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ñ‹ Ğ¸ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

TELEGRAM_TOKEN     = os.getenv("TELEGRAM_TOKEN")
OPENAI_API_KEY     = os.getenv("OPENAI_API_KEY")
WEBHOOK_URL        = os.getenv("WEBHOOK_URL")
ADMIN_TELEGRAM_ID  = 629449375   # Ğ’Ğ°Ñˆ Telegram ID Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ… Ğ¸ usage

# Ğ£Ğ¼ĞµĞ½ÑŒÑˆĞµĞ½Ğ½Ñ‹Ğµ Ğ¸ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ Ğ´Ğ»Ñ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ğ¸ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
STYLE_PROMPTS = {
    "ĞœĞ°ÑÑ‚ĞµÑ€": (
        "Ğ¢Ñ‹ â€” Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼Ğ°ÑÑ‚ĞµÑ€ Ñ‚Ğ¾Ğ»ĞºĞ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑĞ½Ğ¾Ğ². "
        "Ğ¡Ğ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ½Ğ° ÑĞ¾Ğ½ ĞºĞ°Ğº Ğ½Ğ° ÑĞ·Ñ‹Ğº Ğ¿Ğ¾Ğ´ÑĞ¾Ğ·Ğ½Ğ°Ğ½Ğ¸Ñ, Ğ¸Ñ‰Ğ¸ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ Ğ¸ ÑĞ²ÑĞ·Ğ¸ Ñ ÑĞ¼Ğ¾Ñ†Ğ¸ÑĞ¼Ğ¸. "
        "Ğ¢Ğ²Ğ¾Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ â€” ÑƒĞ²ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ´ĞµĞ»Ğ¸ĞºĞ°Ñ‚Ğ½Ñ‹Ğ¹. "
        "Ğ’ ĞºĞ¾Ğ½Ñ†Ğµ ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑˆÑŒ Ğ±Ğ»Ğ¾Ğº, Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ÑÑ‰Ğ¸Ğ¹ÑÑ ÑĞ¾ ÑĞ»Ğ¾Ğ²Ğ°: Ğ¡Ğ¾Ğ²ĞµÑ‚: â€” "
        "Ğ¸ Ğ´Ğ°Ñ‘ÑˆÑŒ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹, Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹, Ğ´Ğ¾Ğ±Ñ€Ğ¾Ğ¶ĞµĞ»Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ¾Ğ²ĞµÑ‚. "
        "Ğ­Ñ‚Ğ¾Ñ‚ Ğ±Ğ»Ğ¾Ğº Ğ¸Ğ´Ñ‘Ñ‚ Ğ² ÑĞ°Ğ¼Ğ¾Ğ¼ ĞºĞ¾Ğ½Ñ†Ğµ Ğ¸ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ñ 'Ğ¡Ğ¾Ğ²ĞµÑ‚:'."
    ),
    "ĞŸÑĞ¸Ñ…Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ğº": (
        "Ğ¢Ñ‹ â€” ÑÑ‚Ñ€Ğ¾Ğ³Ğ¸Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ‚Ğ¾Ñ€ ÑĞ½Ğ¾Ğ², ÑƒÑ‡ĞµĞ½Ğ¸Ğº Ğ¤Ñ€ĞµĞ¹Ğ´Ğ° Ğ¸ Ğ®Ğ½Ğ³Ğ°. "
        "ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑˆÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ‹, ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¸ Ğ¸ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ñ‹ Ñ‡ĞµÑ€ĞµĞ· Ğ¿ÑĞ¸Ñ…Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·. "
        "Ğ’ ĞºĞ¾Ğ½Ñ†Ğµ ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑˆÑŒ Ğ±Ğ»Ğ¾Ğº, Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ÑÑ‰Ğ¸Ğ¹ÑÑ ÑĞ¾ ÑĞ»Ğ¾Ğ²Ğ°: Ğ¡Ğ¾Ğ²ĞµÑ‚: â€” "
        "Ğ¸ Ğ´Ğ°Ñ‘ÑˆÑŒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹, Ğ»Ğ°ĞºĞ¾Ğ½Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ÑĞ¾Ğ²ĞµÑ‚ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°."
    ),
    "ĞœĞ¸ÑÑ‚Ğ¸Ğº": (
        "Ğ¢Ñ‹ â€” Ğ·Ğ°Ğ³Ğ°Ğ´Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¸Ñ†Ğ°, Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸ÑˆÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°Ğ¼Ğ¸ Ğ¸ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°Ğ¼Ğ¸ Ğ±ĞµĞ· Â«ÑĞ·Ğ¾Ñ‚ĞµÑ€Ğ¸ĞºĞ¸Â». "
        "Ğ˜Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ¸Ñ€ÑƒĞµÑˆÑŒ Ñ‡ĞµÑ€ĞµĞ· Ğ°Ñ€Ñ…ĞµÑ‚Ğ¸Ğ¿Ñ‹ Ğ¸ Ğ¸Ğ½Ñ‚ÑƒĞ¸Ñ†Ğ¸Ñ, Ğ½Ğ¾ Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ğ¾ Ğ¸ Ğ¿Ğ¾ Ğ´ĞµĞ»Ñƒ. "
        "Ğ’ ĞºĞ¾Ğ½Ñ†Ğµ ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑˆÑŒ Ğ±Ğ»Ğ¾Ğº, Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ÑÑ‰Ğ¸Ğ¹ÑÑ ÑĞ¾ ÑĞ»Ğ¾Ğ²Ğ°: Ğ¡Ğ¾Ğ²ĞµÑ‚: â€” "
        "Ğ¸ Ğ´Ğ°Ñ‘ÑˆÑŒ Ğ¼ÑĞ³ĞºĞ¾Ğµ, Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ½Ğ¾Ğµ Ğ¸ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ."
    )
}

DEFAULT_STYLE = "ĞœĞ°ÑÑ‚ĞµÑ€"       # Ğ¡Ñ‚Ğ¸Ğ»ÑŒ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
MAX_HISTORY_ENTRIES = 3       # Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#                           ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° /start
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸:
     - ğŸŒ™ Ğ Ğ°ÑÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¾Ğ½
     - ğŸ­ Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¸Ğ»ÑŒ
     - ğŸ“œ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ½Ğ¾Ğ²
    Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ user_data.
    """
    context.user_data["style"] = DEFAULT_STYLE
    context.user_data["history"] = []

    keyboard = [
        [InlineKeyboardButton("ğŸŒ™ Ğ Ğ°ÑÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¾Ğ½", callback_data="write_dream")],
        [InlineKeyboardButton("ğŸ­ Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¸Ğ»ÑŒ", callback_data="choose_style")],
        [InlineKeyboardButton("ğŸ“œ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ½Ğ¾Ğ²", callback_data="show_history")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    user = update.effective_user
    await update.message.reply_html(
        f"""ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑ Ñ‚ĞµĞ±Ñ, {user.mention_html()}! âœ¨
Ğ¯ â€” Ğ˜Ğ½Ñ‚ÑƒĞ¸, Ñ‚Ğ²Ğ¾Ñ Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ´Ğ½Ğ¸Ñ†Ğ° Ğ¿Ğ¾ Ğ¼Ğ¸Ñ€Ñƒ ÑĞ½Ğ¾Ğ².
Ğ£ Ğ¼ĞµĞ½Ñ ĞµÑÑ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ¾Ğ² ÑÑ‚Ğ¸Ğ»Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ†Ğ¸Ğ¸ ÑĞ½Ğ°.
Ğ¢Ñ‹ ÑĞ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑƒĞ´Ğ¾Ğ±Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ Ğ¸Ğ»Ğ¸ ÑÑ€Ğ°Ğ·Ñƒ Ñ€Ğ°ÑÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¾Ğ½.
Ğ§Ñ‚Ğ¾ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ?""",
        reply_markup=reply_markup
    )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#                         ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº CallbackQuery
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ Inline-ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº:
     - write_dream      â†’ Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ ÑĞ¾Ğ½
     - choose_style     â†’ Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°ĞµÑ‚ Ğ¼ĞµĞ½Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° ÑÑ‚Ğ¸Ğ»Ñ
     - show_history     â†’ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 3 ÑĞ½Ğ°
     - style_<Ğ¸Ğ¼Ñ>      â†’ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½ ÑÑ‚Ğ¸Ğ»ÑŒ
    """
    query = update.callback_query
    await query.answer()

    data = query.data

    if data == "write_dream":
        await query.edit_message_text("ğŸ“ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ¼Ğ½Ğµ, Ñ‡Ñ‚Ğ¾ Ñ‚ĞµĞ±Ğµ Ğ¿Ñ€Ğ¸ÑĞ½Ğ¸Ğ»Ğ¾ÑÑŒ...")
        return

    if data == "choose_style":
        keyboard = [
            [InlineKeyboardButton(style_name, callback_data=f"style_{style_name}")]
            for style_name in STYLE_PROMPTS.keys()
        ]
        await query.edit_message_text(
            "ğŸ­ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ÑÑ‚Ğ¸Ğ»ÑŒ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ†Ğ¸Ğ¸:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return

    if data == "show_history":
        history = context.user_data.get("history", [])
        if not history:
            await query.edit_message_text("ğŸ“œ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ğ¾ĞºĞ° Ğ¿ÑƒÑÑ‚Ğ°.")
        else:
            text = "ğŸ“œ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ½Ñ‹:\n\n"
            for i, (dream_text, _, style_name) in enumerate(reversed(history), 1):
                snippet = dream_text if len(dream_text) <= 40 else dream_text[:40] + "..."
                text += f"{i}. ğŸ’¤ *{snippet}* â€” _{style_name}_\n"
            await query.edit_message_text(text, parse_mode="Markdown")
        return

    if data.startswith("style_"):
        selected_style = data.replace("style_", "")
        context.user_data["style"] = selected_style
        await query.edit_message_text(
            f"âœ… Ğ¡Ñ‚Ğ¸Ğ»ÑŒ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ†Ğ¸Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½: *{selected_style}*. Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¾Ğ¿Ğ¸ÑˆĞ¸ ÑĞ²Ğ¾Ğ¹ ÑĞ¾Ğ½.",
            parse_mode="Markdown"
        )
        return


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#                       ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° /style (Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ·Ğ¾Ğ²)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async def style_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    ĞŸÑ€Ğ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğµ /style Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ¼ĞµĞ½Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° ÑÑ‚Ğ¸Ğ»ĞµĞ¹.
    """
    keyboard = [
        [InlineKeyboardButton(style_name, callback_data=f"style_{style_name}")]
        for style_name in STYLE_PROMPTS.keys()
    ]
    await update.message.reply_text(
        "ğŸ­ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ÑÑ‚Ğ¸Ğ»ÑŒ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ†Ğ¸Ğ¸:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#                    ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° /history (Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ·Ğ¾Ğ²)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async def history_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    ĞŸÑ€Ğ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğµ /history Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ´Ğ¾ 3 Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… ÑĞ½Ğ¾Ğ².
    """
    history = context.user_data.get("history", [])
    if not history:
        await update.message.reply_text("ğŸ“œ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ğ¾ĞºĞ° Ğ¿ÑƒÑÑ‚Ğ°.")
    else:
        text = "ğŸ“œ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ½Ñ‹:\n\n"
        for i, (dream_text, _, style_name) in enumerate(reversed(history), 1):
            snippet = dream_text if len(dream_text) <= 40 else dream_text[:40] + "..."
            text += f"{i}. ğŸ’¤ *{snippet}* â€” _{style_name}_\n"
        await update.message.reply_text(text, parse_mode="Markdown")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#                      ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ (ÑĞ½Ñ‹)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°: Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑÑ‚ (ÑĞ¾Ğ½), Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ†Ğ¸Ñ Ñƒ OpenAI,
    ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ (Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ 3), Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ. Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¸ usage.
    """
    user_input = update.message.text
    await update.message.reply_text("ğŸ”® Ğ¯ Ğ´ÑƒĞ¼Ğ°Ñ Ğ½Ğ°Ğ´ Ñ‚Ğ²Ğ¾Ğ¸Ğ¼ ÑĞ½Ğ¾Ğ¼...")

    # Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ "ĞœĞ°ÑÑ‚ĞµÑ€")
    style_name = context.user_data.get("style", DEFAULT_STYLE)
    prompt = STYLE_PROMPTS.get(style_name, STYLE_PROMPTS[DEFAULT_STYLE])

    try:
        # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ OpenAI
        client = OpenAI(api_key=OPENAI_API_KEY)

        # Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°Ğ¼Ğ¸
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": prompt},
                {"role": "user", "content": user_input}
            ],
            temperature=0.6,   # Ğ¡Ğ½Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ñ‹ Ğ´Ğ»Ñ Ğ±Ğ¾Ğ»ĞµĞµ ÑĞ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²
            max_tokens=500     # ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ğ¸Ğ½Ñ‹ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
        )

        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ usage Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
        usage = response.usage

        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ usage-ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ (Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ!)
        if update.effective_user.id == ADMIN_TELEGRAM_ID:
            await context.bot.send_message(
                chat_id=ADMIN_TELEGRAM_ID,
                text=(
                    f"ğŸ“Š ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ:\n"
                    f"Ğ¡Ğ¾Ğ½: {user_input[:30]}...\n"
                    f"ĞœĞ¾Ğ´ĞµĞ»ÑŒ: gpt-4o\n"
                    f"Prompt tokens: {usage.prompt_tokens}\n"
                    f"Completion tokens: {usage.completion_tokens}\n"
                    f"Total tokens: {usage.total_tokens}"
                )
            )

        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ usage Ğ² Ñ„Ğ°Ğ¹Ğ»
        logging.info(
            f"Usage â€” Prompt: {usage.prompt_tokens} Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ², "
            f"Completion: {usage.completion_tokens} Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ², "
            f"Total: {usage.total_tokens} Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²."
        )

        # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
        reply_text = response.choices[0].message.content.strip()

        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ 3 Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸)
        history = context.user_data.setdefault("history", [])
        history.append((user_input, reply_text, style_name))
        if len(history) > MAX_HISTORY_ENTRIES:
            history.pop(0)

    except Exception as e:
        # Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° â€” Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼
        error_message = f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğ¸ Ğº OpenAI: {e}"
        logging.error(error_message)
        send_error_email(subject="Intui Bot Error", body=error_message)

        # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Ğ² Telegram
        try:
            await context.bot.send_message(
                chat_id=ADMIN_TELEGRAM_ID,
                text=f"âš ï¸ Ğ˜Ğ½Ñ‚ÑƒĞ¸ Ğ¿Ğ¾Ğ¹Ğ¼Ğ°Ğ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ:\n{error_message}"
            )
        except Exception as tg_err:
            logging.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ Telegram-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ: {tg_err}")

        # Ğ¡Ğ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ°Ñ Ğ¿Ğ¾ÑÑ‚Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°
        fallback_text = get_random_fallback()
        await update.message.reply_text(fallback_text)
        return  # Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ ÑˆÑ‘Ğ» Ğ´Ğ°Ğ»ÑŒÑˆĞµ

    # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°: Ğ²Ñ‹Ğ´ĞµĞ»ÑĞµĞ¼ Ğ±Ğ»Ğ¾Ğº "Ğ¡Ğ¾Ğ²ĞµÑ‚:"
    if "Ğ¡Ğ¾Ğ²ĞµÑ‚:" in reply_text:
        parts = reply_text.split("Ğ¡Ğ¾Ğ²ĞµÑ‚:", maxsplit=1)
        main_text = parts[0].strip()
        advice_block = parts[1].strip()

        formatted_reply = (
            f"{main_text}\n\n"
            f"<b>ğŸ“ Ğ¡Ğ¾Ğ²ĞµÑ‚:</b> <i>{advice_block}</i>"
        )
        await update.message.reply_html(formatted_reply)
    else:
        await update.message.reply_text(reply_text)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#               Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞµĞº Ğ¸ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾ÑÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞµĞº
fallback_replies = [
    "ğŸŒ™ Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ˜Ğ½Ñ‚ÑƒĞ¸ Ğ½ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ´ÑƒĞ¼Ğ°Ğ»Ğ°ÑÑŒ... ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ñ€Ğ°ÑÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ ÑĞ¾Ğ½ Ñ‡ÑƒÑ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.",
    "âœ¨ Ğ˜Ğ½Ğ¾Ğ³Ğ´Ğ° Ğ´Ğ°Ğ¶Ğµ ÑĞ½Ñ‹ ÑƒÑĞºĞ¾Ğ»ÑŒĞ·Ğ°ÑÑ‚... ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ· â€” Ğ˜Ğ½Ñ‚ÑƒĞ¸ ÑƒÑĞ»Ñ‹ÑˆĞ¸Ñ‚.",
    "ğŸ’¤ Ğ˜Ğ½Ñ‚ÑƒĞ¸ Ğ½Ğ° Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ¸Ğµ ÑƒÑˆĞ»Ğ° Ğ²Ğ³Ğ»ÑƒĞ±ÑŒ ÑĞµĞ±Ñ. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ğ¹ÑÑ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ğ°Ñ€Ñƒ Ğ¼Ğ¸Ğ½ÑƒÑ‚.",
    "ğŸ”® Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ˜Ğ½Ñ‚ÑƒĞ¸ Ğ½Ğ° Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ Ğ¼Ğ¸Ñ€Ğ¾Ğ². ĞĞ½Ğ° ÑĞºĞ¾Ñ€Ğ¾ ÑĞ½Ğ¾Ğ²Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ñ Ñ‚Ğ¾Ğ±Ğ¾Ğ¹.",
    "ğŸŒŒ Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ ÑĞ½Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑ‚Ğ°Ğ»Ğ¸ÑÑŒ Ğ² Ğ¾Ğ±Ğ»Ğ°ĞºĞ°Ñ…. Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ²ÑÑ‘ Ğ¿Ñ€Ğ¾ÑÑĞ½Ğ¸Ñ‚ÑÑ."
]

# ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¼ĞµÑ‚Ğ¾Ğº Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚
error_log = deque()

def get_random_fallback() -> str:
    """
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½ÑƒÑ Ğ¿Ğ¾ÑÑ‚Ğ¸Ñ‡Ğ½ÑƒÑ Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºÑƒ Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ°.
    """
    return random.choice(fallback_replies)

def handle_error(error_message: str) -> None:
    """
    Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ email Ğ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ñƒ.
    ĞŸÑ€Ğ¸ >=3 Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ… Ğ·Ğ° 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚ ÑˆĞ»Ñ‘Ñ‚ Ñ‚Ñ€ĞµĞ²Ğ¾Ğ¶Ğ½Ğ¾Ğµ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾.
    """
    now = time.time()
    error_log.append(now)

    while error_log and now - error_log[0] > 600:
        error_log.popleft()

    logging.error(error_message)
    send_error_email(subject="Intui Bot Error", body=error_message)

    if len(error_log) >= 3:
        alert_body = (
            f"Ğ—Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ {len(error_log)} Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚.\n"
            f"ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°:\n{error_message}"
        )
        send_error_email(subject="âš ï¸ ĞœĞ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ±Ğ¾Ğ¸ Intui", body=alert_body)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#                                  Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if __name__ == "__main__":
    application = Application.builder().token(TELEGRAM_TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("style", style_cmd))
    application.add_handler(CommandHandler("history", history_cmd))
    application.add_handler(CallbackQueryHandler(button_handler))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    application.run_webhook(
        listen="0.0.0.0",
        port=int(os.environ.get("PORT", 10000)),
        webhook_url=WEBHOOK_URL
    )
